<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Smash do Cabo</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="painel.css">
</head>

<body>

<div id="menuLateral"></div>

<div class="content">

  <div class="topbar">
    <h3>Painel Smash do Cabo</h3>
    <div>
      <span>Olá, <strong>Jeniffer Adm</strong></span>
      <button onclick="logout()" class="btn btn-danger btn-sm ms-3">Sair</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-4 mb-4">
    <div class="col-md-2">
      <div class="card-panel nps">
        <div class="kpi-title">NPS</div>
        <div id="npsGeral" class="kpi-value">-</div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card-panel promotores">
        <div class="kpi-title">Promotores</div>
        <div id="npsPromotores" class="kpi-value">-</div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card-panel neutros">
        <div class="kpi-title">Neutros</div>
        <div id="npsNeutros" class="kpi-value">-</div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card-panel detratores">
        <div class="kpi-title">Detratores</div>
        <div id="npsDetratores" class="kpi-value">-</div>
      </div>
    </div>

    <div class="col-md-2">
      <div class="card-panel respostas">
        <div class="kpi-title">Respostas</div>
        <div id="totalRespostas" class="kpi-value">-</div>
      </div>
    </div>
  </div>

  <!-- Filtro -->
  <div class="row mb-3">
    <div class="col-md-3">
      <input type="date" id="dataInicio" class="form-control">
    </div>
    <div class="col-md-3">
      <input type="date" id="dataFim" class="form-control">
    </div>
    <div class="col-md-2">
      <button onclick="aplicarFiltro()" class="btn btn-primary w-100">
        Filtrar
      </button>
    </div>
    <div class="col-md-2">
      <button onclick="limparFiltro()" class="btn btn-outline-secondary w-100">
        Limpar
      </button>
    </div>
  </div>

  <h5 class="mb-3">Últimas Respostas</h5>

  <table class="table-modern">
    <thead>
      <tr>
        <th>Data</th>
        <th>Nome</th>
        <th>Sugestão</th>
        <th>Morador</th>
        <th>Qualidade</th>
        <th>Tempo</th>
        <th>Variedade</th>
        <th>Custo-benefício</th>
      </tr>
    </thead>
    <tbody id="ultimasRespostas"></tbody>
  </table>

</div>

<!-- CONFIG PRIMEIRO -->
<script src="config.js"></script>

<script>

fetch("layout.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("menuLateral").innerHTML = html;
  });

async function carregarPainel(dataInicio = null, dataFim = null) {
  try {

    let query = `
      ${SUPABASE_URL}/rest/v1/feedback_detalhado
      ?select=indicacao,nome,sugestao,morador,qualidade,tempo,variedade,custobeneficio,created_at
      &order=created_at.desc
    `.replace(/\s+/g,'');

    if (dataInicio) query += `&created_at=gte.${dataInicio}T00:00:00`;
    if (dataFim) query += `&created_at=lte.${dataFim}T23:59:59`;

    const res = await fetch(query, {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    });

    if (!res.ok) throw new Error("Erro ao buscar dados");

    const dados = await res.json();

    atualizarKPIs(dados);
    preencherTabela(dados);

  } catch (err) {
    console.error("Erro:", err);
  }
}

function atualizarKPIs(dados) {
  let promotores = 0;
  let neutros = 0;
  let detratores = 0;

  dados.forEach(d => {
    if (d.indicacao >= 9) promotores++;
    else if (d.indicacao >= 7) neutros++;
    else detratores++;
  });

  const total = dados.length;
  const nps = total > 0
    ? Math.round(((promotores - detratores) / total) * 100)
    : 0;

  document.getElementById('npsGeral').textContent = nps;
  document.getElementById('npsPromotores').textContent = promotores;
  document.getElementById('npsNeutros').textContent = neutros;
  document.getElementById('npsDetratores').textContent = detratores;
  document.getElementById('totalRespostas').textContent = total;
}

function preencherTabela(dados) {
  const tbody = document.getElementById('ultimasRespostas');
  tbody.innerHTML = "";

  const badge = (valor) => {
    if (valor === null || valor === undefined) return "-";
    const numero = Number(valor);
    if (numero >= 5) return `<span class="badge badge-5">${numero}</span>`;
    if (numero === 4) return `<span class="badge badge-4">${numero}</span>`;
    return `<span class="badge badge-3">${numero}</span>`;
  };

  dados.slice(0, 20).forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(r.created_at).toLocaleDateString('pt-BR')}</td>
      <td>${r.nome || '-'}</td>
      <td>${r.sugestao || '-'}</td>
      <td>${r.morador || '-'}</td>
      <td>${badge(r.qualidade)}</td>
      <td>${badge(r.tempo)}</td>
      <td>${badge(r.variedade)}</td>
      <td>${badge(r.custobeneficio)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function aplicarFiltro() {
  carregarPainel(
    document.getElementById('dataInicio').value || null,
    document.getElementById('dataFim').value || null
  );
}

function limparFiltro() {
  document.getElementById('dataInicio').value = "";
  document.getElementById('dataFim').value = "";
  filtroMesAtual();
}

function filtroMesAtual() {
  const hoje = new Date();
  const primeiro = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  const ultimo = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

  const formatar = (data) => data.toISOString().split("T")[0];

  const inicio = formatar(primeiro);
  const fim = formatar(ultimo);

  document.getElementById("dataInicio").value = inicio;
  document.getElementById("dataFim").value = fim;

  carregarPainel(inicio, fim);
}

document.addEventListener("DOMContentLoaded", () => {
  filtroMesAtual();
});

</script>

</body>
</html>
